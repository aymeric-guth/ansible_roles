---
- name: Tear down existing services
  community.docker.docker_compose:
    project_src: "{{ _repodir }}/{{ item.repo }}/{{ item.name }}"
    state: absent
  loop: "{{ _repos }}"
  become: true

- name: Start av-external
  community.docker.docker_compose:
    project_src: "{{ _repodir }}/av-external/{{ item }}"
    build: true
  loop:
    - ci
    - main
  become: true

- name: Check gitlab is up
  ansible.builtin.uri:
    url: https://git.ars-virtualis.org
  retries: 30
  delay: 5
  register: result
  until: ('status' in result) and (result.status == 200 or result.status == 401)
  changed_when: false

- name: Start av-api
  community.docker.docker_compose:
    project_src: "{{ _repodir }}/av-api"
    build: true
  become: true
